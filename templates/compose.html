{% extends "base.html" %}

{% block title %}Compose Email{% endblock %}

{% block header_buttons %}
    <button onclick="window.history.back()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition duration-200">
        <i class="fas fa-arrow-left mr-2"></i>Back
    </button>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
        <form id="composeForm">
            <div class="space-y-6">
                <!-- Recipient -->
                <div>
                    <label for="to" class="block text-sm font-medium text-gray-300 mb-2">To:</label>
                    <input type="email" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500" 
                           id="to" required multiple placeholder="recipient@example.com">
                    <p class="text-gray-400 text-sm mt-1">For multiple recipients, separate emails with commas</p>
                </div>
                
                <!-- CC and BCC -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="cc" class="block text-sm font-medium text-gray-300 mb-2">CC:</label>
                        <input type="email" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500" 
                               id="cc" placeholder="cc@example.com">
                    </div>
                    <div>
                        <label for="bcc" class="block text-sm font-medium text-gray-300 mb-2">BCC:</label>
                        <input type="email" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500" 
                               id="bcc" placeholder="bcc@example.com">
                    </div>
                </div>
                
                <!-- Subject -->
                <div>
                    <label for="subject" class="block text-sm font-medium text-gray-300 mb-2">Subject:</label>
                    <input type="text" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500" 
                           id="subject" required placeholder="Email subject">
                </div>
                
                <!-- Message Body -->
                <div>
                    <label for="body" class="block text-sm font-medium text-gray-300 mb-2">Message:</label>
                    <textarea class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500 min-h-[300px]" 
                              id="body" required placeholder="Write your email content here..."></textarea>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-3">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition duration-200">
                        <i class="fas fa-paper-plane mr-2"></i>Send Email
                    </button>
                    <button type="button" onclick="saveDraft()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold transition duration-200">
                        <i class="fas fa-save mr-2"></i>Save Draft
                    </button>
                    <button type="button" onclick="aiEnhance()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition duration-200">
                        <i class="fas fa-robot mr-2"></i>AI Enhance
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    document.getElementById('composeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        sendEmail();
    });

    async function sendEmail() {
        if (!checkAuth()) {
            alert('Please sign in first');
            return;
        }

        const to = document.getElementById('to').value;
        const subject = document.getElementById('subject').value;
        const body = document.getElementById('body').value;
        const cc = document.getElementById('cc').value;
        const bcc = document.getElementById('bcc').value;

        if (!to || !subject || !body) {
            alert('Please fill in all required fields');
            return;
        }

        const tokens = JSON.parse(localStorage.getItem('gmail_tokens'));

        try {
            const response = await fetch('/api/send-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tokens: tokens,
                    to: to,
                    subject: subject,
                    body: body,
                    cc: cc || null,
                    bcc: bcc || null
                })
            });

            const data = await response.json();
            
            if (data.success) {
                alert('Email sent successfully!');
                window.location.href = '/inbox';
            } else {
                alert('Failed to send email: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Network error: ' + error.message);
        }
    }

    function saveDraft() {
        alert('Draft saved functionality would be implemented here');
        // In a full implementation, this would save to Gmail drafts
    }

    async function aiEnhance() {
        const subject = document.getElementById('subject').value;
        const body = document.getElementById('body').value;

        if (!body) {
            alert('Please enter some content to enhance');
            return;
        }

        try {
            const response = await fetch('/api/ai-enhance-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    subject: subject,
                    body: body
                })
            });

            const data = await response.json();
            
            if (data.success) {
                document.getElementById('body').value = data.enhanced_body;
                alert('Email enhanced with AI!');
            } else {
                alert('AI enhancement failed: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Network error: ' + error.message);
        }
    }

    function checkAuth() {
        const tokens = localStorage.getItem('gmail_tokens');
        return !!tokens;
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (!checkAuth()) {
            alert('Please sign in to compose emails');
            window.location.href = '/auth';
        }
    });
</script>
{% endblock %}
